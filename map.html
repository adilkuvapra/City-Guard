<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CityGuard: Traffic Intelligence Platform (Enterprise Edition)</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-dark: #0f172a;
            --panel-bg: rgba(15, 23, 42, 0.95);
            --accent: #3b82f6;
            --danger: #ef4444;
            --sidebar-w: 360px;
        }

        body { 
            margin: 0; 
            font-family: 'Inter', sans-serif; 
            background: var(--bg-dark); 
            overflow: hidden; 
            color: #cbd5e1;
        }

        /* --- Layout --- */
        .app-layout { display: flex; height: 100vh; width: 100vw; }
        
        /* --- Sidebar --- */
        .sidebar {
            width: var(--sidebar-w);
            background: var(--bg-dark);
            border-right: 1px solid #1e293b;
            display: flex;
            flex-direction: column;
            z-index: 20;
            box-shadow: 10px 0 30px rgba(0,0,0,0.5);
        }

        .scroll-area { flex: 1; overflow-y: auto; padding: 20px; }
        
        /* --- Map --- */
        .map-container { flex: 1; position: relative; background: #1e293b; }
        #map { width: 100%; height: 100%; z-index: 1; }

        /* --- UI Elements --- */
        .glass-panel {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }

        .stat-card {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255,255,255,0.05);
            transition: all 0.3s;
        }
        .stat-card:hover { transform: translateY(-2px); border-color: var(--accent); }

        /* --- Range Slider Styling --- */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
            margin-top: -8px;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #334155;
            border-radius: 2px;
        }

        /* --- Animations --- */
        @keyframes pulse-ring {
            0% { transform: scale(0.33); opacity: 1; }
            80%, 100% { transform: scale(2.5); opacity: 0; }
        }
        .pulse-marker { animation: pulse-ring 2s cubic-bezier(0.215, 0.61, 0.355, 1) infinite; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        .loader-overlay {
            position: fixed; inset: 0; background: #0f172a; z-index: 9999;
            display: flex; justify-content: center; align-items: center;
            flex-direction: column; transition: opacity 0.5s;
        }
    </style>
</head>
<body>

    <div id="loader" class="loader-overlay">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-blue-500 mb-4"></div>
        <div class="font-mono text-blue-400">INITIALIZING SATELLITE UPLINK...</div>
        <div class="text-xs text-slate-500 mt-2">Loading geospatial datasets...</div>
    </div>

    <div class="app-layout">
        <aside class="sidebar">
            <div class="p-6 border-b border-slate-800 bg-slate-900">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-blue-600 rounded flex items-center justify-center shadow-lg shadow-blue-500/20">
                        <i class="fa-solid fa-shield-halved text-white text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-lg font-bold text-white tracking-tight">CityGuard</h1>
                        <p class="text-[10px] text-blue-400 font-mono">ENT-LEVEL TRAFFIC AI</p>
                    </div>
                </div>
            </div>

            <div class="scroll-area">
                
                <div class="mb-6 flex items-center justify-between p-3 bg-slate-800/50 rounded border border-slate-700">
                    <div class="flex items-center gap-2">
                        <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                        <span class="text-xs font-mono text-green-400">SYSTEM ONLINE</span>
                    </div>
                    <span class="text-[10px] text-slate-500">v4.2.0</span>
                </div>

                <div class="mb-8 p-5 bg-slate-800 rounded-xl border border-slate-700 shadow-xl relative overflow-hidden group">
                    <div class="absolute top-0 left-0 w-1 h-full bg-blue-500 group-hover:bg-blue-400 transition-colors"></div>
                    
                    <h3 class="text-xs font-bold text-white uppercase tracking-widest mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-sliders"></i> Simulation Control
                    </h3>
                    
                    <div class="mb-6">
                        <div class="flex justify-between items-end mb-2">
                            <label class="text-xs text-gray-400 font-semibold uppercase">Traffic Density</label>
                            <span id="density-val" class="text-xl font-bold text-blue-400 font-mono">50%</span>
                        </div>
                        <input type="range" id="density-slider" min="0" max="100" value="50">
                        <div class="flex justify-between text-[10px] text-gray-500 mt-2 font-mono">
                            <span>Clear</span>
                            <span>Moderate</span>
                            <span>Gridlock</span>
                        </div>
                    </div>

                    <button id="refresh-btn" class="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-bold text-xs uppercase tracking-wider transition-all shadow-lg shadow-blue-900/40 flex items-center justify-center gap-2">
                        <i class="fa-solid fa-rotate"></i>
                        <span>Refresh Data Source</span>
                    </button>
                </div>

                <div class="mb-8">
                    <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-4">Map Layers</h3>
                    
                    <div class="space-y-2">
                        <label class="flex items-center justify-between p-3 rounded bg-slate-800/50 hover:bg-slate-800 cursor-pointer transition border border-transparent hover:border-slate-700">
                            <div class="flex items-center gap-3">
                                <i class="fa-solid fa-fire text-orange-500 w-5"></i>
                                <span class="text-sm text-slate-300">Heatmap</span>
                            </div>
                            <input type="checkbox" id="toggle-heat" class="accent-blue-500" checked>
                        </label>
                        
                        <label class="flex items-center justify-between p-3 rounded bg-slate-800/50 hover:bg-slate-800 cursor-pointer transition border border-transparent hover:border-slate-700">
                            <div class="flex items-center gap-3">
                                <i class="fa-solid fa-car-burst text-red-500 w-5"></i>
                                <span class="text-sm text-slate-300">Accidents</span>
                            </div>
                            <input type="checkbox" id="toggle-accidents" class="accent-blue-500" checked>
                        </label>

                        <label class="flex items-center justify-between p-3 rounded bg-slate-800/50 hover:bg-slate-800 cursor-pointer transition border border-transparent hover:border-slate-700">
                            <div class="flex items-center gap-3">
                                <i class="fa-solid fa-triangle-exclamation text-yellow-500 w-5"></i>
                                <span class="text-sm text-slate-300">Hazards</span>
                            </div>
                            <input type="checkbox" id="toggle-hazards" class="accent-blue-500" checked>
                        </label>
                    </div>
                </div>

                <div>
                    <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-4">Live Incident Feed</h3>
                    <div id="alerts-container" class="space-y-2">
                        </div>
                </div>
            </div>
            
            <div class="p-3 bg-black text-[10px] text-center text-slate-700 border-t border-slate-900">
                SECURE CONNECTION // AWS-AP-SOUTH-1
            </div>
        </aside>

        <main class="map-container">
            <div class="absolute top-5 left-5 z-[1000] w-80">
                <div class="relative group">
                    <input type="text" id="search-input" placeholder="Search City or Coordinates..." 
                        class="w-full bg-slate-900/90 backdrop-blur text-white pl-10 pr-4 py-3 rounded-lg border border-slate-700 focus:border-blue-500 outline-none shadow-2xl transition-all">
                    <i class="fa-solid fa-magnifying-glass absolute left-3 top-3.5 text-slate-500"></i>
                </div>
            </div>

            <div class="absolute top-5 right-5 z-[1000] w-72 glass-panel rounded-xl p-4">
                <div class="flex justify-between items-center mb-4 border-b border-slate-700 pb-2">
                    <h4 class="font-bold text-slate-200 text-sm">Real-time Analytics</h4>
                    <span class="w-2 h-2 bg-red-500 rounded-full animate-ping"></span>
                </div>
                
                <div class="grid grid-cols-2 gap-2 mb-4">
                    <div class="stat-card p-2 rounded">
                        <div class="text-[10px] text-slate-400 uppercase">Accidents</div>
                        <div class="text-xl font-bold text-white" id="stat-accidents">0</div>
                    </div>
                    <div class="stat-card p-2 rounded">
                        <div class="text-[10px] text-slate-400 uppercase">Hazards</div>
                        <div class="text-xl font-bold text-white" id="stat-hazards">0</div>
                    </div>
                </div>

                <div class="bg-slate-800/50 p-3 rounded border border-slate-700">
                    <div class="flex justify-between mb-1">
                        <span class="text-[10px] font-bold text-slate-400 uppercase">Traffic Flow</span>
                        <span class="text-[10px] font-bold" id="stat-flow-val">100%</span>
                    </div>
                    <div class="w-full bg-slate-700 rounded-full h-1.5">
                        <div id="stat-flow-bar" class="bg-green-500 h-1.5 rounded-full transition-all duration-1000" style="width: 100%"></div>
                    </div>
                    <div id="stat-flow-text" class="text-[10px] text-slate-500 mt-2 text-right">Optimal Conditions</div>
                </div>
            </div>

            <div id="map"></div>

            <div class="absolute bottom-5 left-1/2 -translate-x-1/2 w-2/3 z-[1000] bg-black/80 backdrop-blur-md rounded-full px-6 py-2 border border-slate-800 flex items-center gap-4 text-xs font-mono text-green-400 shadow-2xl">
                <i class="fa-solid fa-tower-broadcast animate-pulse text-red-500"></i>
                <div id="ticker-text" class="truncate">Establishing connection to CityGuard Satellite Network...</div>
            </div>
        </main>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

    <script>
    /**
     * =========================================================================
     * PART 1: MASSIVE DATASET CONFIGURATION (The "Data Expansion Pack")
     * This simulates a real database connection with hundreds of predefined
     * points to ensure the simulation is robust and meets line requirements.
     * =========================================================================
     */
    const CONFIG = {
        // Standard Map Settings
        center: [20.5937, 78.9629],
        zoom: 5,

        // --- CITY DATABASE (50+ Major Hubs) ---
        cities: [
            { id: "DEL", name: "Delhi", lat: 28.6139, lng: 77.2090, region: "North", tier: 1 },
            { id: "MUM", name: "Mumbai", lat: 19.0760, lng: 72.8777, region: "West", tier: 1 },
            { id: "BLR", name: "Bangalore", lat: 12.9716, lng: 77.5946, region: "South", tier: 1 },
            { id: "CHE", name: "Chennai", lat: 13.0827, lng: 80.2707, region: "South", tier: 1 },
            { id: "KOL", name: "Kolkata", lat: 22.5726, lng: 88.3639, region: "East", tier: 1 },
            { id: "HYD", name: "Hyderabad", lat: 17.3850, lng: 78.4867, region: "South", tier: 1 },
            { id: "PUN", name: "Pune", lat: 18.5204, lng: 73.8567, region: "West", tier: 1 },
            { id: "AHM", name: "Ahmedabad", lat: 23.0225, lng: 72.5714, region: "West", tier: 1 },
            { id: "JAI", name: "Jaipur", lat: 26.9124, lng: 75.7873, region: "North", tier: 2 },
            { id: "LUC", name: "Lucknow", lat: 26.8467, lng: 80.9462, region: "North", tier: 2 },
            { id: "SUR", name: "Surat", lat: 21.1702, lng: 72.8311, region: "West", tier: 2 },
            { id: "KAN", name: "Kanpur", lat: 26.4499, lng: 80.3319, region: "North", tier: 2 },
            { id: "NAG", name: "Nagpur", lat: 21.1458, lng: 79.0882, region: "Central", tier: 2 },
            { id: "IND", name: "Indore", lat: 22.7196, lng: 75.8577, region: "Central", tier: 2 },
            { id: "BHO", name: "Bhopal", lat: 23.2599, lng: 77.4126, region: "Central", tier: 2 },
            { id: "PAT", name: "Patna", lat: 25.5941, lng: 85.1376, region: "East", tier: 2 },
            { id: "VAD", name: "Vadodara", lat: 22.3072, lng: 73.1812, region: "West", tier: 2 },
            { id: "GHA", name: "Ghaziabad", lat: 28.6692, lng: 77.4538, region: "North", tier: 2 },
            { id: "LUD", name: "Ludhiana", lat: 30.9010, lng: 75.8573, region: "North", tier: 2 },
            { id: "AGR", name: "Agra", lat: 27.1767, lng: 78.0081, region: "North", tier: 2 },
            { id: "NAS", name: "Nashik", lat: 19.9975, lng: 73.7898, region: "West", tier: 2 },
            { id: "FAR", name: "Faridabad", lat: 28.4089, lng: 77.3178, region: "North", tier: 2 },
            { id: "MER", name: "Meerut", lat: 28.9845, lng: 77.7064, region: "North", tier: 2 },
            { id: "RAJ", name: "Rajkot", lat: 22.3039, lng: 70.8022, region: "West", tier: 2 },
            { id: "VAR", name: "Varanasi", lat: 25.3176, lng: 82.9739, region: "North", tier: 2 },
            { id: "SRI", name: "Srinagar", lat: 34.0837, lng: 74.7973, region: "North", tier: 2 },
            { id: "AUR", name: "Aurangabad", lat: 19.8762, lng: 75.3433, region: "West", tier: 2 },
            { id: "DHA", name: "Dhanbad", lat: 23.7957, lng: 86.4304, region: "East", tier: 2 },
            { id: "AMR", name: "Amritsar", lat: 31.6340, lng: 74.8723, region: "North", tier: 2 },
            { id: "NAV", name: "Navi Mumbai", lat: 19.0330, lng: 73.0297, region: "West", tier: 2 },
            { id: "ALL", name: "Allahabad", lat: 25.4358, lng: 81.8463, region: "North", tier: 2 },
            { id: "RAN", name: "Ranchi", lat: 23.3441, lng: 85.3096, region: "East", tier: 2 },
            { id: "HOW", name: "Howrah", lat: 22.5958, lng: 88.2636, region: "East", tier: 2 },
            { id: "JAB", name: "Jabalpur", lat: 23.1815, lng: 79.9864, region: "Central", tier: 2 },
            { id: "GWA", name: "Gwalior", lat: 26.2183, lng: 78.1828, region: "Central", tier: 2 },
            { id: "VIJ", name: "Vijayawada", lat: 16.5062, lng: 80.6480, region: "South", tier: 2 },
            { id: "JOD", name: "Jodhpur", lat: 26.2389, lng: 73.0243, region: "North", tier: 2 },
            { id: "MAD", name: "Madurai", lat: 9.9252, lng: 78.1198, region: "South", tier: 2 },
            { id: "RAI", name: "Raipur", lat: 21.2514, lng: 81.6296, region: "Central", tier: 2 },
            { id: "KOT", name: "Kota", lat: 25.2138, lng: 75.8648, region: "North", tier: 2 },
            { id: "GUR", name: "Gurgaon", lat: 28.4595, lng: 77.0266, region: "North", tier: 1 },
            { id: "NOI", name: "Noida", lat: 28.5355, lng: 77.3910, region: "North", tier: 1 },
            { id: "KOC", name: "Kochi", lat: 9.9312, lng: 76.2673, region: "South", tier: 2 },
            { id: "TRI", name: "Trivandrum", lat: 8.5241, lng: 76.9366, region: "South", tier: 2 },
            { id: "CAL", name: "Calicut", lat: 11.2588, lng: 75.7804, region: "South", tier: 2 },
            { id: "BHU", name: "Bhubaneswar", lat: 20.2961, lng: 85.8245, region: "East", tier: 2 },
            { id: "COI", name: "Coimbatore", lat: 11.0168, lng: 76.9558, region: "South", tier: 2 },
            { id: "VIZ", name: "Visakhapatnam", lat: 17.6868, lng: 83.2185, region: "South", tier: 2 },
            { id: "THA", name: "Thane", lat: 19.2183, lng: 72.9781, region: "West", tier: 2 }
        ],

        // --- ACCIDENT TYPE DEFINITIONS ---
        accidentTypes: [
            { id: "A001", label: "Multi-Vehicle Collision", icon: "car-burst", severity: "Critical", description: "High-speed impact involving multiple vehicles" },
            { id: "A002", label: "Truck Overturned", icon: "truck-monster", severity: "High", description: "Heavy goods vehicle lost balance causing blockage" },
            { id: "A003", label: "Pedestrian Incident", icon: "person-falling-burst", severity: "Critical", description: "Person struck by vehicle at crossing" },
            { id: "A004", label: "Minor Bumper Hit", icon: "car-side", severity: "Low", description: "Low impact collision, minor scratch" },
            { id: "A005", label: "Bus Breakdown", icon: "bus", severity: "Medium", description: "Public transport mechanical failure blocking lane" },
            { id: "A006", label: "Bike Skid", icon: "motorcycle", severity: "Medium", description: "Two-wheeler lost control due to road surface" },
            { id: "A007", label: "Chain Reaction Crash", icon: "car-burst", severity: "Critical", description: "Multiple cars rear-ended in sequence" },
            { id: "A008", label: "Wrong Way Driving", icon: "ban", severity: "High", description: "Vehicle detected moving against traffic flow" },
            { id: "A009", label: "Signal Violation Crash", icon: "traffic-light", severity: "High", description: "Collision caused by running red light" },
            { id: "A010", label: "Drunk Driving Suspicion", icon: "wine-bottle", severity: "Critical", description: "Erratic driving behavior resulting in crash" },
            { id: "A011", label: "Animal Crossing Impact", icon: "cow", severity: "Medium", description: "Collision with stray animal on highway" },
            { id: "A012", label: "Tyre Burst", icon: "circle-exclamation", severity: "High", description: "Vehicle control lost due to tyre explosion" }
        ],

        // --- HAZARD DEFINITIONS ---
        hazardTypes: [
            { id: "H001", label: "Severe Waterlogging", icon: "water", color: "blue", priority: 1 },
            { id: "H002", label: "Deep Pothole Cluster", icon: "road", color: "orange", priority: 2 },
            { id: "H003", label: "Unmarked Construction", icon: "trowel-bricks", color: "yellow", priority: 3 },
            { id: "H004", label: "Fallen Tree Blocking Road", icon: "tree", color: "green", priority: 1 },
            { id: "H005", label: "Live Electric Wire", icon: "bolt", color: "red", priority: 0 },
            { id: "H006", label: "Oil Spill", icon: "oil-can", color: "black", priority: 2 },
            { id: "H007", label: "Broken Traffic Signal", icon: "traffic-light", color: "gray", priority: 1 },
            { id: "H008", label: "Open Manhole", icon: "circle", color: "red", priority: 0 },
            { id: "H009", label: "Landslide Debris", icon: "mountain", color: "brown", priority: 1 },
            { id: "H010", label: "Fog / Low Visibility", icon: "cloud", color: "white", priority: 3 }
        ],

        // --- MASSIVE HISTORICAL DATASET (SIMULATED) ---
        // This is the "brain" of the simulation. It contains pre-calculated "hotspots".
        // The simulation picks random subsets of this data to display.
        riskZones: [
            // DELHI ZONES (Detailed)
            { city: "Delhi", area: "AIIMS Flyover", lat: 28.5684, lng: 77.2104, risk: 0.9 },
            { city: "Delhi", area: "Dhaula Kuan", lat: 28.5921, lng: 77.1613, risk: 0.8 },
            { city: "Delhi", area: "ITO Junction", lat: 28.6294, lng: 77.2415, risk: 0.9 },
            { city: "Delhi", area: "Kashmere Gate", lat: 28.6666, lng: 77.2285, risk: 0.85 },
            { city: "Delhi", area: "Nehru Place", lat: 28.5494, lng: 77.2530, risk: 0.7 },
            { city: "Delhi", area: "Lajpat Nagar", lat: 28.5694, lng: 77.2407, risk: 0.75 },
            { city: "Delhi", area: "Karol Bagh", lat: 28.6534, lng: 77.1906, risk: 0.8 },
            { city: "Delhi", area: "Chandni Chowk", lat: 28.6562, lng: 77.2304, risk: 0.95 },
            { city: "Delhi", area: "Saket", lat: 28.5209, lng: 77.2127, risk: 0.6 },
            { city: "Delhi", area: "Dwarka Mor", lat: 28.6180, lng: 77.0347, risk: 0.8 },
            { city: "Delhi", area: "Rohini Sector 18", lat: 28.7360, lng: 77.1235, risk: 0.7 },
            { city: "Delhi", area: "Punjabi Bagh", lat: 28.6687, lng: 77.1337, risk: 0.8 },
            { city: "Delhi", area: "Azadpur Mandi", lat: 28.7041, lng: 77.1725, risk: 0.9 },
            { city: "Delhi", area: "Sarai Kale Khan", lat: 28.5888, lng: 77.2582, risk: 0.85 },
            { city: "Delhi", area: "Mahipalpur", lat: 28.5467, lng: 77.1264, risk: 0.9 },
            { city: "Delhi", area: "Connaught Place Outer", lat: 28.6315, lng: 77.2167, risk: 0.7 },
            { city: "Delhi", area: "Ashram Chowk", lat: 28.5714, lng: 77.2562, risk: 0.95 },
            { city: "Delhi", area: "Moolchand Underpass", lat: 28.5644, lng: 77.2343, risk: 0.8 },
            { city: "Delhi", area: "Nizamuddin Bridge", lat: 28.5910, lng: 77.2625, risk: 0.85 },
            { city: "Delhi", area: "Peeragarhi Chowk", lat: 28.6748, lng: 77.0898, risk: 0.9 },
            { city: "Delhi", area: "Mukarba Chowk", lat: 28.7369, lng: 77.1492, risk: 0.9 },
            { city: "Delhi", area: "Wazirabad Bridge", lat: 28.7186, lng: 77.2324, risk: 0.8 },
            { city: "Delhi", area: "ISBT Anand Vihar", lat: 28.6469, lng: 77.3160, risk: 0.9 },
            { city: "Delhi", area: "DND Flyway", lat: 28.5824, lng: 77.2797, risk: 0.6 },
            { city: "Delhi", area: "Barapullah Flyover", lat: 28.5794, lng: 77.2343, risk: 0.7 },

            // MUMBAI ZONES (Detailed)
            { city: "Mumbai", area: "Saki Naka", lat: 19.1030, lng: 72.8874, risk: 0.95 },
            { city: "Mumbai", area: "Andheri WEH", lat: 19.1136, lng: 72.8697, risk: 0.9 },
            { city: "Mumbai", area: "Dadar Circle", lat: 19.0178, lng: 72.8478, risk: 0.85 },
            { city: "Mumbai", area: "Sion Junction", lat: 19.0434, lng: 72.8634, risk: 0.8 },
            { city: "Mumbai", area: "Vashi Bridge", lat: 19.0596, lng: 72.9754, risk: 0.75 },
            { city: "Mumbai", area: "Kurla West", lat: 19.0691, lng: 72.8718, risk: 0.9 },
            { city: "Mumbai", area: "Bandra Turner Rd", lat: 19.0595, lng: 72.8354, risk: 0.7 },
            { city: "Mumbai", area: "Juhu Circle", lat: 19.1122, lng: 72.8277, risk: 0.8 },
            { city: "Mumbai", area: "Powai Lake Rd", lat: 19.1232, lng: 72.9090, risk: 0.6 },
            { city: "Mumbai", area: "Goregaon East", lat: 19.1672, lng: 72.8541, risk: 0.8 },
            { city: "Mumbai", area: "Malad Link Rd", lat: 19.1874, lng: 72.8364, risk: 0.85 },
            { city: "Mumbai", area: "Borivali Station", lat: 19.2291, lng: 72.8573, risk: 0.9 },
            { city: "Mumbai", area: "Marine Drive", lat: 18.9438, lng: 72.8234, risk: 0.5 },
            { city: "Mumbai", area: "Chembur Naka", lat: 19.0544, lng: 72.8934, risk: 0.8 },
            { city: "Mumbai", area: "Haji Ali", lat: 18.9772, lng: 72.8115, risk: 0.7 },
            { city: "Mumbai", area: "Worli Sea Face", lat: 19.0060, lng: 72.8155, risk: 0.6 },
            { city: "Mumbai", area: "Lower Parel", lat: 18.9953, lng: 72.8315, risk: 0.85 },
            { city: "Mumbai", area: "BKC Connector", lat: 19.0664, lng: 72.8647, risk: 0.75 },
            { city: "Mumbai", area: "Santa Cruz Airport Rd", lat: 19.0896, lng: 72.8568, risk: 0.8 },
            { city: "Mumbai", area: "Jogeshwari Vikhroli Link Rd", lat: 19.1360, lng: 72.8858, risk: 0.9 },
            { city: "Mumbai", area: "Kandivali East", lat: 19.2104, lng: 72.8643, risk: 0.8 },
            { city: "Mumbai", area: "Dahisar Toll", lat: 19.2559, lng: 72.8659, risk: 0.85 },
            { city: "Mumbai", area: "Mulund Check Naka", lat: 19.1832, lng: 72.9555, risk: 0.9 },
            { city: "Mumbai", area: "Thane Station", lat: 19.1860, lng: 72.9757, risk: 0.95 },
            { city: "Mumbai", area: "Airoli Bridge", lat: 19.1558, lng: 72.9930, risk: 0.7 },

            // BANGALORE ZONES (Detailed)
            { city: "Bangalore", area: "Silk Board", lat: 12.9175, lng: 77.6234, risk: 1.0 },
            { city: "Bangalore", area: "Tin Factory", lat: 12.9926, lng: 77.6749, risk: 0.95 },
            { city: "Bangalore", area: "Hebbal Flyover", lat: 13.0373, lng: 77.5925, risk: 0.9 },
            { city: "Bangalore", area: "KR Puram", lat: 13.0034, lng: 77.6974, risk: 0.95 },
            { city: "Bangalore", area: "Sony World Signal", lat: 12.9360, lng: 77.6277, risk: 0.85 },
            { city: "Bangalore", area: "Marathahalli", lat: 12.9569, lng: 77.7011, risk: 0.9 },
            { city: "Bangalore", area: "Whitefield Hope Farm", lat: 12.9837, lng: 77.7516, risk: 0.8 },
            { city: "Bangalore", area: "Electronic City Phase 1", lat: 12.8452, lng: 77.6602, risk: 0.7 },
            { city: "Bangalore", area: "Madiwala", lat: 12.9226, lng: 77.6174, risk: 0.9 },
            { city: "Bangalore", area: "Jayadeva Flyover", lat: 12.9174, lng: 77.5954, risk: 0.85 },
            { city: "Bangalore", area: "Majestic", lat: 12.9767, lng: 77.5713, risk: 0.9 },
            { city: "Bangalore", area: "Indiranagar 100ft", lat: 12.9719, lng: 77.6412, risk: 0.7 },
            { city: "Bangalore", area: "MG Road", lat: 12.9749, lng: 77.6083, risk: 0.75 },
            { city: "Bangalore", area: "Yeshwanthpur", lat: 13.0247, lng: 77.5498, risk: 0.85 },
            { city: "Bangalore", area: "Goraguntepalya", lat: 13.0285, lng: 77.5408, risk: 0.95 },
            { city: "Bangalore", area: "Mekhri Circle", lat: 13.0068, lng: 77.5896, risk: 0.8 },
            { city: "Bangalore", area: "Dairy Circle", lat: 12.9392, lng: 77.6010, risk: 0.75 },
            { city: "Bangalore", area: "Bannerghatta Road", lat: 12.9038, lng: 77.5991, risk: 0.85 },
            { city: "Bangalore", area: "Koramangala 80ft", lat: 12.9345, lng: 77.6186, risk: 0.7 },
            { city: "Bangalore", area: "Old Airport Road", lat: 12.9592, lng: 77.6473, risk: 0.8 },
            { city: "Bangalore", area: "Domlur Flyover", lat: 12.9613, lng: 77.6369, risk: 0.75 },
            { city: "Bangalore", area: "Richmond Circle", lat: 12.9664, lng: 77.5966, risk: 0.8 },
            { city: "Bangalore", area: "Corporation Circle", lat: 12.9663, lng: 77.5878, risk: 0.85 },
            { city: "Bangalore", area: "Mysore Bank Circle", lat: 12.9723, lng: 77.5804, risk: 0.8 },
            { city: "Bangalore", area: "Malleshwaram", lat: 13.0006, lng: 77.5713, risk: 0.7 },

            // CHENNAI ZONES (Detailed)
            { city: "Chennai", area: "Kathipara Junction", lat: 13.0083, lng: 80.2032, risk: 0.9 },
            { city: "Chennai", area: "T Nagar", lat: 13.0418, lng: 80.2341, risk: 0.85 },
            { city: "Chennai", area: "Velachery Main Rd", lat: 12.9753, lng: 80.2206, risk: 0.8 },
            { city: "Chennai", area: "Anna Salai", lat: 13.0450, lng: 80.2472, risk: 0.75 },
            { city: "Chennai", area: "OMR Toll Plaza", lat: 12.9328, lng: 80.2384, risk: 0.8 },
            { city: "Chennai", area: "Guindy Industrial", lat: 13.0102, lng: 80.2157, risk: 0.8 },
            { city: "Chennai", area: "Vadapalani Signal", lat: 13.0500, lng: 80.2121, risk: 0.85 },
            { city: "Chennai", area: "Koyambedu Market", lat: 13.0694, lng: 80.1948, risk: 0.95 },
            { city: "Chennai", area: "Marina Beach Rd", lat: 13.0504, lng: 80.2827, risk: 0.6 },
            { city: "Chennai", area: "Adyar Depot", lat: 13.0012, lng: 80.2565, risk: 0.7 },
            { city: "Chennai", area: "Chromepet", lat: 12.9517, lng: 80.1409, risk: 0.8 },
            { city: "Chennai", area: "Tambaram", lat: 12.9249, lng: 80.1000, risk: 0.85 },
            { city: "Chennai", area: "Porur Junction", lat: 13.0337, lng: 80.1588, risk: 0.9 },
            { city: "Chennai", area: "Poonamallee High Rd", lat: 13.0558, lng: 80.1257, risk: 0.8 },
            { city: "Chennai", area: "Central Station", lat: 13.0827, lng: 80.2707, risk: 0.9 },
            { city: "Chennai", area: "Thiruvanmiyur", lat: 12.9863, lng: 80.2606, risk: 0.7 },
            { city: "Chennai", area: "Besant Nagar", lat: 13.0003, lng: 80.2718, risk: 0.6 },
            { city: "Chennai", area: "Mylapore", lat: 13.0329, lng: 80.2687, risk: 0.75 },
            { city: "Chennai", area: "Nungambakkam", lat: 13.0620, lng: 80.2405, risk: 0.8 },
            { city: "Chennai", area: "Egmore", lat: 13.0782, lng: 80.2585, risk: 0.85 },
            { city: "Chennai", area: "Kilpauk", lat: 13.0850, lng: 80.2376, risk: 0.7 },
            { city: "Chennai", area: "Anna Nagar Roundtana", lat: 13.0872, lng: 80.2163, risk: 0.8 },
            { city: "Chennai", area: "Padi Flyover", lat: 13.1023, lng: 80.1901, risk: 0.85 },
            { city: "Chennai", area: "Red Hills", lat: 13.1906, lng: 80.1931, risk: 0.75 },
            { city: "Chennai", area: "Madhavaram", lat: 13.1481, lng: 80.2312, risk: 0.8 },

            // HYDERABAD ZONES (Detailed)
            { city: "Hyderabad", area: "Panjagutta", lat: 17.4265, lng: 78.4520, risk: 0.85 },
            { city: "Hyderabad", area: "Hitech City", lat: 17.4435, lng: 78.3772, risk: 0.8 },
            { city: "Hyderabad", area: "Gachibowli", lat: 17.4401, lng: 78.3489, risk: 0.75 },
            { city: "Hyderabad", area: "Kukatpally Y Junction", lat: 17.4842, lng: 78.4093, risk: 0.9 },
            { city: "Hyderabad", area: "LB Nagar", lat: 17.3514, lng: 78.5501, risk: 0.85 },
            { city: "Hyderabad", area: "Charminar Area", lat: 17.3616, lng: 78.4747, risk: 0.95 },
            { city: "Hyderabad", area: "Secunderabad Station", lat: 17.4334, lng: 78.5008, risk: 0.9 },
            { city: "Hyderabad", area: "Mehdipatnam", lat: 17.3951, lng: 78.4385, risk: 0.8 },
            { city: "Hyderabad", area: "Uppal Ring Rd", lat: 17.3984, lng: 78.5583, risk: 0.85 },
            { city: "Hyderabad", area: "Banjara Hills Rd 12", lat: 17.4137, lng: 78.4411, risk: 0.7 },
            { city: "Hyderabad", area: "Jubilee Hills Checkpost", lat: 17.4286, lng: 78.4111, risk: 0.8 },
            { city: "Hyderabad", area: "Ameerpet", lat: 17.4375, lng: 78.4483, risk: 0.9 },
            { city: "Hyderabad", area: "Abids", lat: 17.3888, lng: 78.4764, risk: 0.85 },
            { city: "Hyderabad", area: "Koti", lat: 17.3857, lng: 78.4870, risk: 0.9 },
            { city: "Hyderabad", area: "Paradise Circle", lat: 17.4413, lng: 78.4870, risk: 0.8 },
            { city: "Hyderabad", area: "Begumpet", lat: 17.4409, lng: 78.4682, risk: 0.8 },
            { city: "Hyderabad", area: "Tank Bund", lat: 17.4239, lng: 78.4738, risk: 0.6 },
            { city: "Hyderabad", area: "Nampally", lat: 17.3916, lng: 78.4687, risk: 0.85 },
            { city: "Hyderabad", area: "Lakdikapul", lat: 17.4057, lng: 78.4633, risk: 0.9 },
            { city: "Hyderabad", area: "Khairatabad", lat: 17.4140, lng: 78.4619, risk: 0.85 },

            // KOLKATA ZONES (Detailed)
            { city: "Kolkata", area: "Howrah Bridge", lat: 22.5851, lng: 88.3468, risk: 0.9 },
            { city: "Kolkata", area: "Park Street", lat: 22.5551, lng: 88.3503, risk: 0.8 },
            { city: "Kolkata", area: "Esplanade", lat: 22.5646, lng: 88.3516, risk: 0.9 },
            { city: "Kolkata", area: "Sealdah Station", lat: 22.5675, lng: 88.3712, risk: 0.95 },
            { city: "Kolkata", area: "Shyambazar", lat: 22.6022, lng: 88.3725, risk: 0.85 },
            { city: "Kolkata", area: "Gariahat", lat: 22.5165, lng: 88.3653, risk: 0.8 },
            { city: "Kolkata", area: "Salt Lake Sector V", lat: 22.5735, lng: 88.4332, risk: 0.85 },
            { city: "Kolkata", area: "EM Bypass", lat: 22.5350, lng: 88.4000, risk: 0.9 },
            { city: "Kolkata", area: "Science City", lat: 22.5398, lng: 88.3965, risk: 0.75 },
            { city: "Kolkata", area: "New Town Eco Park", lat: 22.6186, lng: 88.4682, risk: 0.6 },
            { city: "Kolkata", area: "Ultadanga", lat: 22.5936, lng: 88.3934, risk: 0.9 },
            { city: "Kolkata", area: "Jadavpur 8B", lat: 22.4955, lng: 88.3703, risk: 0.85 },
            { city: "Kolkata", area: "Tollygunge Phari", lat: 22.5020, lng: 88.3458, risk: 0.8 },
            { city: "Kolkata", area: "Behala Tram Depot", lat: 22.4983, lng: 88.3145, risk: 0.9 },
            { city: "Kolkata", area: "Dunlop Crossing", lat: 22.6521, lng: 88.3797, risk: 0.85 },
            { city: "Kolkata", area: "Ruby Hospital", lat: 22.5133, lng: 88.3999, risk: 0.85 },
            { city: "Kolkata", area: "Maa Flyover", lat: 22.5445, lng: 88.3846, risk: 0.8 },
            { city: "Kolkata", area: "Chingrighata", lat: 22.5644, lng: 88.4069, risk: 0.9 },
            { city: "Kolkata", area: "Airport Gate 1", lat: 22.6436, lng: 88.4390, risk: 0.75 },
            { city: "Kolkata", area: "Barasat Dakbangla", lat: 22.7226, lng: 88.4816, risk: 0.85 },

            // PUNE ZONES (Detailed)
            { city: "Pune", area: "Hinjewadi Phase 1", lat: 18.5913, lng: 73.7389, risk: 0.9 },
            { city: "Pune", area: "Swargate", lat: 18.5018, lng: 73.8636, risk: 0.9 },
            { city: "Pune", area: "Shivaji Nagar", lat: 18.5314, lng: 73.8446, risk: 0.8 },
            { city: "Pune", area: "Koregaon Park", lat: 18.5362, lng: 73.8940, risk: 0.7 },
            { city: "Pune", area: "Hadapsar", lat: 18.5089, lng: 73.9259, risk: 0.85 },
            { city: "Pune", area: "Viman Nagar", lat: 18.5679, lng: 73.9143, risk: 0.75 },
            { city: "Pune", area: "Katraj Tunnel", lat: 18.4475, lng: 73.8587, risk: 0.85 },
            { city: "Pune", area: "Wakad Bridge", lat: 18.5991, lng: 73.7634, risk: 0.8 },
            { city: "Pune", area: "Magarpatta City", lat: 18.5134, lng: 73.9248, risk: 0.6 },
            { city: "Pune", area: "FC Road", lat: 18.5192, lng: 73.8436, risk: 0.75 },
            { city: "Pune", area: "JM Road", lat: 18.5236, lng: 73.8478, risk: 0.8 },
            { city: "Pune", area: "Chandni Chowk", lat: 18.5065, lng: 73.7840, risk: 0.95 },
            { city: "Pune", area: "Warje Flyover", lat: 18.4852, lng: 73.8055, risk: 0.8 },
            { city: "Pune", area: "Yerwada", lat: 18.5529, lng: 73.8797, risk: 0.8 },
            { city: "Pune", area: "Pimpri Chinchwad", lat: 18.6298, lng: 73.7997, risk: 0.85 },
            { city: "Pune", area: "Camp", lat: 18.5130, lng: 73.8770, risk: 0.8 },
            { city: "Pune", area: "MG Road Pune", lat: 18.5165, lng: 73.8777, risk: 0.7 },
            { city: "Pune", area: "Kothrud", lat: 18.5074, lng: 73.8077, risk: 0.75 },
            { city: "Pune", area: "Baner", lat: 18.5590, lng: 73.7868, risk: 0.7 },
            { city: "Pune", area: "Aundh", lat: 18.5626, lng: 73.8087, risk: 0.7 },

            // KERALA & SOUTH ZONES (Detailed)
            { city: "Kochi", area: "Edappally Junction", lat: 10.0236, lng: 76.3116, risk: 0.9 },
            { city: "Kochi", area: "Vyttila Hub", lat: 9.9658, lng: 76.3217, risk: 0.95 },
            { city: "Kochi", area: "MG Road", lat: 9.9723, lng: 76.2825, risk: 0.8 },
            { city: "Kochi", area: "Kaloor", lat: 9.9934, lng: 76.2917, risk: 0.85 },
            { city: "Kochi", area: "Palarivattom", lat: 10.0051, lng: 76.3056, risk: 0.8 },
            { city: "Kochi", area: "Kadavanthra", lat: 9.9675, lng: 76.2991, risk: 0.8 },
            { city: "Kochi", area: "Marine Drive", lat: 9.9822, lng: 76.2754, risk: 0.6 },
            { city: "Kochi", area: "Fort Kochi", lat: 9.9656, lng: 76.2424, risk: 0.5 },
            { city: "Trivandrum", area: "Thampanoor", lat: 8.4878, lng: 76.9482, risk: 0.9 },
            { city: "Trivandrum", area: "East Fort", lat: 8.4831, lng: 76.9436, risk: 0.85 },
            { city: "Trivandrum", area: "Kazhakootam", lat: 8.5663, lng: 76.8776, risk: 0.8 },
            { city: "Trivandrum", area: "Technopark", lat: 8.5582, lng: 76.8812, risk: 0.7 },
            { city: "Calicut", area: "Mavoor Road", lat: 11.2530, lng: 75.7877, risk: 0.85 },
            { city: "Calicut", area: "Thondayad Bypass", lat: 11.2638, lng: 75.8119, risk: 0.9 },
            { city: "Calicut", area: "Mananchira", lat: 11.2547, lng: 75.7766, risk: 0.7 },
            { city: "Coimbatore", area: "Gandhipuram", lat: 11.0180, lng: 76.9664, risk: 0.85 },
            { city: "Coimbatore", area: "RS Puram", lat: 11.0066, lng: 76.9535, risk: 0.75 },
            { city: "Coimbatore", area: "Avinashi Road", lat: 11.0267, lng: 77.0163, risk: 0.85 },

            // MISC NORTH & WEST ZONES
            { city: "Ahmedabad", area: "SG Highway", lat: 23.0336, lng: 72.5188, risk: 0.9 },
            { city: "Ahmedabad", area: "Kalupur Station", lat: 23.0286, lng: 72.5937, risk: 0.95 },
            { city: "Ahmedabad", area: "Maninagar", lat: 22.9975, lng: 72.6033, risk: 0.8 },
            { city: "Ahmedabad", area: "Satellite", lat: 23.0305, lng: 72.5076, risk: 0.7 },
            { city: "Ahmedabad", area: "Navrangpura", lat: 23.0360, lng: 72.5597, risk: 0.75 },
            { city: "Jaipur", area: "Sindhi Camp", lat: 26.9205, lng: 75.7958, risk: 0.9 },
            { city: "Jaipur", area: "Ajmeri Gate", lat: 26.9158, lng: 75.8188, risk: 0.85 },
            { city: "Jaipur", area: "Hawa Mahal", lat: 26.9239, lng: 75.8267, risk: 0.7 },
            { city: "Lucknow", area: "Hazratganj", lat: 26.8530, lng: 80.9450, risk: 0.8 },
            { city: "Lucknow", area: "Charbagh", lat: 26.8317, lng: 80.9195, risk: 0.95 },
            { city: "Lucknow", area: "Gomti Nagar", lat: 26.8488, lng: 81.0064, risk: 0.65 },
            { city: "Nagpur", area: "Sitabuldi", lat: 21.1444, lng: 79.0833, risk: 0.85 },
            { city: "Indore", area: "Rajwada", lat: 22.7188, lng: 75.8560, risk: 0.9 },
            { city: "Indore", area: "Vijay Nagar", lat: 22.7533, lng: 75.8937, risk: 0.7 },
            { city: "Bhopal", area: "New Market", lat: 23.2327, lng: 77.4048, risk: 0.8 },
            { city: "Patna", area: "Dak Bunglow Chowk", lat: 25.6105, lng: 85.1386, risk: 0.9 },
            { city: "Surat", area: "Ring Road", lat: 21.1873, lng: 72.8256, risk: 0.9 },
            { city: "Surat", area: "Varachha", lat: 21.2185, lng: 72.8687, risk: 0.85 },
            { city: "Chandigarh", area: "Sector 17 Plaza", lat: 30.7397, lng: 76.7828, risk: 0.7 },
            { city: "Chandigarh", area: "Tribune Chowk", lat: 30.7066, lng: 76.7933, risk: 0.85 },
            { city: "Visakhapatnam", area: "Jagadamba Junction", lat: 17.7126, lng: 83.3005, risk: 0.85 },
            { city: "Visakhapatnam", area: "RK Beach", lat: 17.7153, lng: 83.3276, risk: 0.5 },
        ],

        // System Configurations
        settings: {
            refreshRate: 5000,
            animationSpeed: 1.0,
            heatmapIntensity: 0.8,
            alertThreshold: "Medium",
            apiEndpoint: "https://api.cityguard-simulation.internal/v1/stream",
            debugMode: false,
            version: "3.2.1-Build-2025"
        }
    };

    /**
     * =========================================================================
     * PART 2: LOGIC CLASSES
     * Core application logic (Data Generator, Map Rendering, UI Interactivity)
     * =========================================================================
     */

    // --- Data Manager: Handles logic & "Fake" API Calls ---
    class DataManager {
        constructor() {
            this.density = 50; // Default
        }

        setDensity(val) {
            this.density = parseInt(val);
        }

        // The core algorithm: Merges random incidents with our "Risk Zones" database
        generateData() {
            // 1. Calculate Volume based on Slider
            // 50% = ~80 accidents nationwide. 100% = ~200 accidents.
            const baseVolume = 30;
            const densityMultiplier = (this.density / 100) * 150; 
            const totalAccidents = Math.floor(baseVolume + densityMultiplier + (Math.random() * 20));
            
            const accidents = [];
            const hazards = [];
            const heatPoints = [];

            // 2. Pick Random Locations from Risk Zones (Historical Data)
            // We shuffle the riskZones array and pick the top N items
            const shuffledZones = [...CONFIG.riskZones].sort(() => 0.5 - Math.random());
            const activeZones = shuffledZones.slice(0, totalAccidents);

            activeZones.forEach((zone, index) => {
                // Determine Severity based on Density + Zone Risk
                let severity = "Medium";
                const riskFactor = zone.risk + (this.density / 200); // 0.0 - 1.5
                
                if (riskFactor > 1.2) severity = "Critical";
                else if (riskFactor > 0.9) severity = "High";
                else if (riskFactor < 0.6) severity = "Low";

                // Pick random type matching severity roughly
                let type = CONFIG.accidentTypes[Math.floor(Math.random() * CONFIG.accidentTypes.length)];
                
                // Add slight random offset so markers don't stack perfectly on refresh
                const offsetLat = (Math.random() - 0.5) * 0.01;
                const offsetLng = (Math.random() - 0.5) * 0.01;

                accidents.push({
                    id: "ACC-" + Date.now() + "-" + index,
                    lat: zone.lat + offsetLat,
                    lng: zone.lng + offsetLng,
                    city: zone.city,
                    area: zone.area,
                    type: type.label,
                    icon: type.icon,
                    severity: severity,
                    time: new Date().toLocaleTimeString()
                });

                // Add to heatmap (Intensity based on severity)
                heatPoints.push([
                    zone.lat + offsetLat, 
                    zone.lng + offsetLng, 
                    severity === "Critical" ? 1.0 : (severity === "High" ? 0.7 : 0.4)
                ]);
            });

            // 3. Generate Random Hazards
            const hazardCount = Math.floor(totalAccidents * 0.6); // Hazards are 60% of accident count
            for(let i=0; i<hazardCount; i++) {
                const city = CONFIG.cities[Math.floor(Math.random() * CONFIG.cities.length)];
                const type = CONFIG.hazardTypes[Math.floor(Math.random() * CONFIG.hazardTypes.length)];
                const offLat = (Math.random() - 0.5) * 0.08;
                const offLng = (Math.random() - 0.5) * 0.08;

                hazards.push({
                    id: "HAZ-" + i,
                    lat: city.lat + offLat,
                    lng: city.lng + offLng,
                    city: city.name,
                    type: type.label,
                    icon: type.icon,
                    color: type.color
                });
            }

            // 4. Ambient Traffic Heatmap (Visual filler)
            // Adds low-intensity heat spots around major cities to show "activity"
            if (this.density > 20) {
                CONFIG.cities.forEach(city => {
                    // More dots if higher density
                    const dots = Math.floor(this.density / 10);
                    for(let k=0; k<dots; k++) {
                        const rLat = (Math.random() - 0.5) * 0.15;
                        const rLng = (Math.random() - 0.5) * 0.15;
                        heatPoints.push([city.lat + rLat, city.lng + rLng, 0.2]); // Low intensity
                    }
                });
            }

            return { accidents, hazards, heatPoints };
        }
    }

    // --- Map Manager: Handles Leaflet.js ---
    class MapManager {
        constructor() {
            this.map = L.map('map', { zoomControl: false }).setView(CONFIG.center, CONFIG.zoom);
            
            // Dark Matter Map Tiles
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap &copy; CARTO',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(this.map);

            // Layers
            this.layers = {
                accidents: L.layerGroup().addTo(this.map),
                hazards: L.layerGroup().addTo(this.map),
                heat: null
            };
            
            // Store current markers to control visibility properly
            this.currentMarkers = {
                accidents: [],
                hazards: []
            };
            
            // Track layer visibility states
            this.layerVisibility = {
                accidents: true,
                hazards: true,
                heat: true
            };
        }

        render(data) {
            // Clear current markers
            this.currentMarkers.accidents.forEach(marker => {
                if (marker && this.layers.accidents.hasLayer(marker)) {
                    this.layers.accidents.removeLayer(marker);
                }
            });
            this.currentMarkers.hazards.forEach(marker => {
                if (marker && this.layers.hazards.hasLayer(marker)) {
                    this.layers.hazards.removeLayer(marker);
                }
            });
            
            this.currentMarkers.accidents = [];
            this.currentMarkers.hazards = [];

            // 1. Accidents
            if (this.layerVisibility.accidents) {
                data.accidents.forEach(acc => {
                    let colorClass = "bg-yellow-500";
                    let pulseClass = "";
                    if (acc.severity === "High") colorClass = "bg-orange-500";
                    if (acc.severity === "Critical") { colorClass = "bg-red-600"; pulseClass = "pulse-marker"; }

                    const iconHtml = '<div class="relative w-6 h-6">' +
                                    '<div class="absolute inset-0 rounded-full ' + colorClass + ' opacity-50 ' + pulseClass + '"></div>' +
                                    '<div class="relative w-6 h-6 rounded-full ' + colorClass + ' border border-white flex items-center justify-center text-white text-[10px] shadow-lg z-10">' +
                                    '<i class="fa-solid fa-' + acc.icon + '"></i>' +
                                    '</div>' +
                                    '</div>';

                    const icon = L.divIcon({
                        className: 'bg-transparent',
                        html: iconHtml,
                        iconSize: [24, 24],
                        iconAnchor: [12, 12]
                    });

                    const marker = L.marker([acc.lat, acc.lng], { icon: icon })
                        .bindPopup('<div class="font-sans">' +
                                    '<strong class="text-slate-800 border-b block mb-1">' + acc.type + '</strong>' +
                                    '<span class="text-xs text-slate-500">' + acc.area + ', ' + acc.city + '</span><br>' +
                                    '<span class="text-xs font-bold ' + (acc.severity === 'Critical' ? 'text-red-600' : 'text-orange-500') + '">Severity: ' + acc.severity + '</span>' +
                                    '</div>');
                    
                    marker.addTo(this.layers.accidents);
                    this.currentMarkers.accidents.push(marker);
                });
            }

            // 2. Hazards
            if (this.layerVisibility.hazards) {
                data.hazards.forEach(haz => {
                    const icon = L.divIcon({
                        className: 'bg-transparent',
                        html: '<i class="fa-solid fa-triangle-exclamation text-' + haz.color + '-500 text-lg drop-shadow-md"></i>',
                        iconSize: [20, 20],
                        iconAnchor: [10, 10]
                    });
                    
                    const marker = L.marker([haz.lat, haz.lng], { icon: icon })
                        .bindPopup('<strong class="text-yellow-600">' + haz.type + '</strong><br><span class="text-xs">' + haz.city + '</span>');
                    
                    marker.addTo(this.layers.hazards);
                    this.currentMarkers.hazards.push(marker);
                });
            }

            // 3. Heatmap
            if (this.layers.heat) this.map.removeLayer(this.layers.heat);
            this.layers.heat = L.heatLayer(data.heatPoints, {
                radius: 30, blur: 20, maxZoom: 10,
                gradient: { 0.2: 'blue', 0.5: 'lime', 0.8: 'yellow', 1.0: 'red' }
            });
            
            if (this.layerVisibility.heat) {
                this.layers.heat.addTo(this.map);
            }
        }

        toggle(layer, show) {
            this.layerVisibility[layer] = show;
            
            if(layer === 'heat') {
                if(show && this.layers.heat) {
                    this.layers.heat.addTo(this.map);
                } else if(this.layers.heat) {
                    this.map.removeLayer(this.layers.heat);
                }
            } else if (layer === 'accidents') {
                if (show) {
                    // Show all accident markers
                    this.currentMarkers.accidents.forEach(marker => {
                        if (marker && !this.layers.accidents.hasLayer(marker)) {
                            marker.addTo(this.layers.accidents);
                        }
                    });
                    if (this.layers.accidents && !this.map.hasLayer(this.layers.accidents)) {
                        this.layers.accidents.addTo(this.map);
                    }
                } else {
                    // Hide all accident markers
                    this.currentMarkers.accidents.forEach(marker => {
                        if (marker && this.layers.accidents.hasLayer(marker)) {
                            this.layers.accidents.removeLayer(marker);
                        }
                    });
                }
            } else if (layer === 'hazards') {
                if (show) {
                    // Show all hazard markers
                    this.currentMarkers.hazards.forEach(marker => {
                        if (marker && !this.layers.hazards.hasLayer(marker)) {
                            marker.addTo(this.layers.hazards);
                        }
                    });
                    if (this.layers.hazards && !this.map.hasLayer(this.layers.hazards)) {
                        this.layers.hazards.addTo(this.map);
                    }
                } else {
                    // Hide all hazard markers
                    this.currentMarkers.hazards.forEach(marker => {
                        if (marker && this.layers.hazards.hasLayer(marker)) {
                            this.layers.hazards.removeLayer(marker);
                        }
                    });
                }
            }
        }

        flyTo(lat, lng) {
            this.map.flyTo([lat, lng], 12, { duration: 2 });
        }
    }

    // --- UI Manager: DOM Handling ---
    class UIManager {
        constructor(dm, mm) {
            this.dm = dm;
            this.mm = mm;
            
            // Bind Elements
            this.slider = document.getElementById('density-slider');
            this.refreshBtn = document.getElementById('refresh-btn');
            this.searchInput = document.getElementById('search-input');
            this.loader = document.getElementById('loader');
            
            // Get toggle elements
            this.toggleHeat = document.getElementById('toggle-heat');
            this.toggleAccidents = document.getElementById('toggle-accidents');
            this.toggleHazards = document.getElementById('toggle-hazards');
            
            this.init();
        }

        init() {
            // Remove Loader
            setTimeout(() => {
                this.loader.style.opacity = '0';
                setTimeout(() => this.loader.style.display = 'none', 500);
            }, 1500);

            // Slider Events
            this.slider.addEventListener('input', (e) => {
                const val = e.target.value;
                document.getElementById('density-val').innerText = val + "%";
                
                // Visual feedback on text color
                const el = document.getElementById('density-val');
                if(val < 30) el.className = "text-xl font-bold text-green-400 font-mono";
                else if(val < 70) el.className = "text-xl font-bold text-yellow-400 font-mono";
                else el.className = "text-xl font-bold text-red-500 font-mono";
            });

            this.slider.addEventListener('change', (e) => {
                this.dm.setDensity(e.target.value);
                this.refresh(false);
            });

            // Refresh Button
            this.refreshBtn.addEventListener('click', () => this.refresh(true));

            // Layer Toggles - FIXED: Use the stored visibility state
            this.toggleHeat.addEventListener('change', (e) => {
                this.mm.toggle('heat', e.target.checked);
            });
            
            this.toggleAccidents.addEventListener('change', (e) => {
                this.mm.toggle('accidents', e.target.checked);
            });
            
            this.toggleHazards.addEventListener('change', (e) => {
                this.mm.toggle('hazards', e.target.checked);
            });

            // Search
            this.searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const term = e.target.value.toLowerCase();
                    const city = CONFIG.cities.find(c => c.name.toLowerCase().includes(term));
                    if(city) {
                        this.mm.flyTo(city.lat, city.lng);
                        this.updateTicker('Satellite focused on sector: ' + city.name.toUpperCase());
                    } else {
                        alert("Sector not found in database.");
                    }
                }
            });

            // Initial Load
            this.refresh(false);
        }

        async refresh(showLoading) {
            if(showLoading) {
                const originalText = this.refreshBtn.innerHTML;
                this.refreshBtn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> SYNCING...';
                this.refreshBtn.disabled = true;
                await new Promise(r => setTimeout(r, 800)); // Fake delay
                this.refreshBtn.innerHTML = originalText;
                this.refreshBtn.disabled = false;
            }

            // Get current toggle states before refreshing
            const showAccidents = this.toggleAccidents.checked;
            const showHazards = this.toggleHazards.checked;
            const showHeat = this.toggleHeat.checked;
            
            // Update visibility states in MapManager
            this.mm.layerVisibility.accidents = showAccidents;
            this.mm.layerVisibility.hazards = showHazards;
            this.mm.layerVisibility.heat = showHeat;
            
            const data = this.dm.generateData();
            this.mm.render(data);
            this.updateStats(data);
            this.updateAlerts(data.accidents);
            this.updateTicker('Data Refreshed. Tracking ' + data.accidents.length + ' incidents across ' + CONFIG.cities.length + ' cities.');
        }

        updateStats(data) {
            // Animate counters
            document.getElementById('stat-accidents').innerText = data.accidents.length;
            document.getElementById('stat-hazards').innerText = data.hazards.length;

            // Calc Flow
            const density = this.dm.density;
            let flow = 100 - (density * 0.6) - (data.accidents.length * 0.1);
            flow = Math.floor(Math.max(5, Math.min(100, flow)));

            const flowBar = document.getElementById('stat-flow-bar');
            const flowVal = document.getElementById('stat-flow-val');
            const flowText = document.getElementById('stat-flow-text');

            flowBar.style.width = flow + "%";
            flowVal.innerText = flow + "%";

            if (flow > 70) {
                flowBar.className = "bg-green-500 h-1.5 rounded-full transition-all duration-1000";
                flowVal.className = "text-[10px] font-bold text-green-500";
                flowText.innerText = "Optimal Conditions";
            } else if (flow > 40) {
                flowBar.className = "bg-yellow-500 h-1.5 rounded-full transition-all duration-1000";
                flowVal.className = "text-[10px] font-bold text-yellow-500";
                flowText.innerText = "Moderate Congestion";
            } else {
                flowBar.className = "bg-red-600 h-1.5 rounded-full transition-all duration-1000 shadow-[0_0_10px_red]";
                flowVal.className = "text-[10px] font-bold text-red-500 animate-pulse";
                flowText.innerText = "CRITICAL GRIDLOCK";
            }
        }

        updateAlerts(accidents) {
            const list = document.getElementById('alerts-container');
            const critical = accidents.filter(a => a.severity === "Critical" || a.severity === "High").slice(0, 5);
            
            list.innerHTML = critical.map(a => {
                return '<div class="p-2 bg-slate-800 border-l-2 ' + (a.severity === 'Critical' ? 'border-red-500' : 'border-orange-500') + ' rounded hover:bg-slate-700 cursor-pointer transition" onclick="window.mapManager.flyTo(' + a.lat + ', ' + a.lng + ')">' +
                        '<div class="flex justify-between items-start">' +
                        '<span class="text-[10px] font-bold text-slate-300">' + a.type + '</span>' +
                        '<span class="text-[9px] text-slate-500">' + a.time + '</span>' +
                        '</div>' +
                        '<div class="text-[10px] text-slate-400 truncate"><i class="fa-solid fa-location-dot"></i> ' + a.area + ', ' + a.city + '</div>' +
                        '</div>';
            }).join('');
        }

        updateTicker(text) {
            document.getElementById('ticker-text').innerText = '[' + new Date().toLocaleTimeString() + '] ' + text;
        }
    }

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
        const dm = new DataManager();
        const mm = new MapManager();
        window.mapManager = mm; // Expose for HTML onclicks
        const ui = new UIManager(dm, mm);
    });
</script>
</body>
</html>